# Паттерн "Наблюдатель"

## Что такое паттерн?

**Паттерн** на русском языке - **шаблон**.

Это выработанный людьми, за многие годы 
программирования(и не только), относительно абстрактный 
способ решать или описывать ту, или иную проблему.

Например, если я скажу "автомобиль", то вы вероятно 
мысленно нарисуете железный каркас, колёса, фары, стёкла,
и т д.

Я не назвал ни марки автомобиля, ни модели, ни ещё
какой-либо описывающей информации, и с некоторой стороны
это очень хорошо, так как мы с вами поняли друг друга, а
детали, очевидно, в данный момент не нужны, или не важны.

Также "выглядят" паттерны в программировании. Они указывают
как можно решить задачу, не давая при этом чётких инструкций.

Шаблонов много, они имеют разное назначение, разную сложность
реализации. В этой статье я постараюсь познакомить вас с 
паттерном Наблюдатель.

## "Наблюдатель"

Наверняка вы на что-нибудь да подписаны. На получение газет,
на получение рассылки нужной вам информации с какого-нибудь сайта,
на получение "свежих" анекдотов по СМС каждый день.

В любом случае тот, кто присылает вам эту информацию, является
её источником, издателем, а вы в свою очередь - потребителем, или
подписчиком.

> Обратите внимание - информацию получают не все, а только те, 
кто заявил о своём желании получать новости источнику информации

Как это выглядит?

Вы приходите в издательство и говорите: "вот мой адрес, я хочу
получать экземпляр каждой вашей новой газеты".

Издатель в свою очередь внёс вас в список тех ужасных людей, кто
потворствует вырубке деревьев!!!

Далее, при наступлении определённого события, то есть - выхода
нового выпуска газеты, осуществляется её доставка на ваш адрес, а
также на адреса всех остальных людей, кто подписался.

Взгляните, у нас есть три варианта построения взаимоотношений
издатель - подписчики:
* издательство отправляет вам свежий выпуск газеты курьером
* мобильный оператор присылает вам анекдот СМС-кой
* сайт уведомляет о появлении интересовавшего вас товара, или 
статьи

Меняются способы доставки, вид отправляемых данных, но каждый раз
реализуется одна и та же модель поведения.

Выделим ключевые моменты:
* издатель
* подписчик
* оформление подписки
* возникновение события
* отправка данных подписчикам

Давайте теперь уже более осознанно пройдём по примерам, держа в уме 
эти ключевые моменты.

### Пример "Газетное издательство".

* **Издатель** - газетное издательство
* **Подписчик** - вы или сэр Джон, живущий напротив, в общем - человек
* **Оформление подписки** - приход в издательство и оставление заявки
* **Возникновение события** - выход нового газетного выпуска
* **Отправка данных подписчикам** - курьеры доставляют газеты по
адресам

### Пример "Получение анекдотов по СМС".

* **Издатель** - оператор сотовой связи
* **Подписчик** - снова вы, однако данные приходят на ваш телефон
* **Оформление подписки** - отправка СМС с заявкой о получении
анекдотов
* **Возникновение события** - наступление нового дня
* **Отправка данных подписчикам** - отправка СМС с анекдотом на 
ваш номер телефона

### Пример "Уведомление от сайта".

* **Издатель** - сайт, товарами или статьями которого вы 
заинтересованы
* **Подписчик** - вы, однако данные приходят на ваш email
* **Оформление подписки** - тут вариантов масса, но мы представим,
что вы добровольно оставили свой email, чтобы узнать о появлении 
интересующей вас информации
* **Возникновение события** - поступление товара на склад(хотя
тут, как и в других примерах, о многом умалчивается)
* **Отправка данных подписчикам** - рассылка email писем на
email адреса

## Релизация

Простейшая реализация.

Издатель. Издателем у нас будет простой объект, который будет 
иметь два метода `subscribe` и `notify`.

```javascript
const publisher = {
    subscribe() {
        // code
    },
    
    notify() {
        // code
    },
};
```

Также не будем забывать, что издатель должен вести списки тех,
кто подписан на уведомления от него.

```javascript
const publisher = {
	eventSubscribers: new Map(),

    subscribe() {
        // code
    },

    notify() {
        // code
    },
};
```

Отлично. Кто же у нас будет подписчиком? Сделаем подписчиками
функции. Так в данный момент будет проще.

То есть будем реализовывать следующий алгоритм:
1. Издатель(`publisher`) получает нового подписчика(`функцию`),
которого интересует конкретное событие(`event`),
и записывает его в список подписчиков(`eventSubscribers`)
2. При наступлении события(`event`), вызывается функция
уведомления(`notify`), которая обегает всех 
подписчиков(`eventSubscribers`), раздавая новую информацию
3. А подписчики(`eventSubscribers`) уже делают с ней, что хотят.

В коде это может выглядеть так:

```javascript
const publisher = {
    // Отображение Событие -> Подписчики
    eventSubscribers: new Map(),
    
    /**
    * Функция подписки на событие
    * @param {string} event
    * @param {function} fn
    */
    subscribe(event, fn) {
        // Если ещё никто не подписался на конкретное событие
        if (!this.eventSubscribers.has(event)) {
            // Создаём массив подписчиков на это событие
            this.eventSubscribers.set(event, []);
        }
        
        // Добавляем подписчика на событие в массив
        this.eventSubscribers.get(event).push(fn);
    },
    
    /**
    * Функция, получающая событие и данные для отправки подписчикам
    * @param {string} event
    * @param {*} args
    */
    notify(event, ...args) {
        // Получение массива функций-подписчиков для определённого события
        const subscribers = this.eventSubscribers.get(event) || [];
    
        // Вызов каждой функции-подписчика с данными
        subscribers.forEach(subscriber => subscriber(...args));
    },
};
```

Пример использования

```javascript
const buyForFriend = product => {
    console.log(`Купить и подарить другу появившийся на прилавках ${product}`);
};
const buyForTest = product => {
    console.log(`Купить и протестировать новый ${product}`);
};

publisher.subscribe('new-product', buyForFriend);
publisher.subscribe('new-product', buyForTest);

publisher.notify('new-product', 'Квадракоптер G504-DX');

// В консоли мы увидим следующее
Купить другу появившийся на прилавках Квадракоптер G504-DX
Купить и протестировать новый Квадракоптер G504-DX
```